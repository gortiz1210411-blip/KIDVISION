<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FL Standards Tracker — Simple</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FL Standards">
<link rel="apple-touch-icon" href="icon-192.png">
<script defer src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js">
// ----- CSV Import (roster) -----
const studentCSV = document.getElementById('studentCSV');
const importStudentsBtn = document.getElementById('importStudentsBtn');
const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');

downloadTemplateBtn.addEventListener('click', ()=>{
  const tmpl = 'name\nAlice Johnson\nBob Smith\n';
  const blob = new Blob([tmpl], {type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'roster-template.csv'; a.click();
});

importStudentsBtn.addEventListener('click', async ()=>{
  const f = studentCSV.files && studentCSV.files[0];
  if(!f) return alert('Choose a CSV file first.');
  const text = await f.text();
  const rows = text.split(/\r?\n/).filter(r => r.trim().length);
  if(!rows.length) return alert('CSV is empty.');
  const headers = rows[0].split(',').map(h=>h.trim().toLowerCase());
  const nameIdx = headers.indexOf('name');
  if(nameIdx === -1) return alert('CSV must include a "name" column in the first row.');
  let added = 0;
  for(let i=1;i<rows.length;i++){
    const cols = rows[i].split(',');
    const nm = (cols[nameIdx]||'').trim();
    if(!nm) continue;
    // avoid dupes: skip if same name already exists
    if(STUDENTS.some(s => (s.name||'').trim().toLowerCase() === nm.toLowerCase())) continue;
    STUDENTS.push({name: nm});
    added++;
  }
  if(added){ renderStudents(); alert('Imported '+added+' students.'); }
  else { alert('No new students found to import.'); }
});


// === Robust CSV import (overrides previous handler) ===
(function(){
  const studentCSV = document.getElementById('studentCSV');
  const importStudentsBtn = document.getElementById('importStudentsBtn');

  function normalizeHeader(h){
    if(!h) return "";
    // strip quotes and BOM, trim, lower
    return String(h)
      .replace(/^[\"\']|[\"\']$/g,"")
      .replace(/^\uFEFF/,"")
      .trim()
      .toLowerCase();
  }

  function splitLine(line){
    // prefer comma, but if no commas and tabs exist, use tab
    if (line.indexOf(",") === -1 && line.indexOf("\t") !== -1){
      return line.split("\t");
    }
    // otherwise split on commas
    return line.split(",");
  }

  async function importRoster(){
    const f = studentCSV && studentCSV.files ? studentCSV.files[0] : null;
    if(!f){ alert('Choose a CSV file first.'); return; }
    let text = await f.text();
    // normalize newlines
    text = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
    const lines = text.split("\n").filter(r => r.trim().length);
    if(!lines.length){ alert('CSV is empty.'); return; }

    // Parse header
    let headers = splitLine(lines[0]).map(normalizeHeader);
    // if single empty header and single column of data, treat as 'name'
    if (headers.length === 1 && headers[0] === "") headers[0] = "name";

    // Find name column (accept 'name' or 'student' or 'student_name')
    let nameIdx = headers.findIndex(h => h === "name" || h === "student" || h === "student_name");
    if (nameIdx === -1){
      alert('Could not find a name column. Please include a header named "name".');
      return;
    }

    let added = 0, seen = new Set(STUDENTS.map(s => (s.name||"").trim().toLowerCase()));
    for (let i=1; i<lines.length; i++){
      const cols = splitLine(lines[i]).map(v => {
        v = v.replace(/^[\"\']|[\"\']$/g,"").replace(/^\uFEFF/,"").trim();
        return v;
      });
      const nm = (cols[nameIdx]||"").trim();
      if (!nm) continue;
      const key = nm.toLowerCase();
      if (seen.has(key)) continue;
      STUDENTS.push({name: nm});
      seen.add(key);
      added++;
    }
    renderStudents();
    alert(added ? ('Imported ' + added + ' students.') : 'No new students to import.');
  }

  // Remove old click handlers by cloning the node (cheap and safe)
  if (importStudentsBtn){
    const clone = importStudentsBtn.cloneNode(true);
    importStudentsBtn.parentNode.replaceChild(clone, importStudentsBtn);
    clone.addEventListener('click', importRoster);
  }
})();

</script>
<style>
:root { --bg:#0b1020; --card:#121a32; --accent:#6ae3ff; --muted:#9fb0d0; --line:#1e2a49; }
* { box-sizing:border-box }
html,body { margin:0; height:100%; font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial; color:#e6f0ff; background:var(--bg) }
.app { max-width:900px; margin:0 auto; padding:14px }
header { display:flex; align-items:center; gap:8px; justify-content:space-between; margin-bottom:10px }
.brand { font-weight:800; letter-spacing:.2px }
.tabs { display:flex; gap:6px }
.tab { border:1px solid var(--line); background:#0f1832; border-radius:999px; padding:6px 10px; color:#cfe2ff; cursor:pointer }
.tab.active { background:#243152; color:#fff; border-color:#3a4a74 }
.card { background:var(--card); border:1px solid var(--line); border-radius:16px; padding:12px; box-shadow:0 10px 26px rgba(0,0,0,.25) }
.row { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
input,select,textarea,button { background:#0d152b; border:1px solid var(--line); color:#e6f0ff; border-radius:10px; padding:10px 12px; font-size:16px }
textarea { width:100%; min-height:80px }
h3 { margin:0 0 8px 0 }
small.muted { color:#9fb0d0 }
table { width:100%; border-collapse:collapse }
th,td { border-bottom:1px solid var(--line); padding:8px 6px; text-align:left; vertical-align:top }
th { position:sticky; top:0; background:#0f1832; z-index:1 }
.right { margin-left:auto }
.badge { border:1px solid var(--line); padding:2px 8px; border-radius:999px; color:#bcd1ff; font-size:12px }
.section { display:none }
.section.active { display:block }
.toggle { display:flex; align-items:center; gap:8px }
button:active { transform:scale(0.99) }
hr.split { border:0; border-top:1px solid var(--line); margin:10px 0 }
.note { font-size:12px; color:#9fb0d0 }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="row">
      <span class="brand">FL Standards Tracker</span>
      <span class="badge">Simple Mode</span>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="quick">Quick Rate</button>
      <button class="tab" data-tab="records">Records</button>
      <button class="tab" data-tab="student">Student View</button>
      <button class="tab" data-tab="settings">Settings</button>
    </div>
  </header>

  <section id="quick" class="section active card">
    <h3>Quick Rate</h3>
    <div class="row">
      <select id="studentSelect" style="flex:1"></select>
      <select id="subjectSelect" style="flex:1"></select>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="standardSearch" placeholder="Search standard (code or text)…" style="flex:1">
      <select id="standardSelect" style="flex:1"></select>
    </div>
    <div class="row" style="margin-top:8px">
      <div id="ratingGroup" class="row">
        <button data-v="1">1</button><button data-v="2">2</button><button data-v="3">3</button><button data-v="4">4</button><button data-v="5">5</button>
      </div>
      <input id="dateInput" type="date" class="right">
    </div>
    <textarea id="notes" placeholder="Notes / evidence / accommodations…"></textarea>
    <div class="row" style="margin-top:8px">
      <button id="saveBtn">Save</button>
      <small class="muted">5 = Proficient · 1 = Not proficient</small>
    </div>
  </section>

  <section id="records" class="section card">
    <h3>Records</h3>
    <div class="row" style="margin:8px 0">
      <input id="filterStudent" placeholder="Filter by student…" style="flex:1">
      <input id="filterCode" placeholder="Filter by code or text…" style="flex:1">
      <select id="filterSubject"></select>
      <select id="filterRating">
        <option value="">All</option><option>5</option><option>4</option><option>3</option><option>2</option><option>1</option>
      </select>
      <button id="exportBtn" class="right">Export CSV</button>
    </div>
    <div style="max-height:380px;overflow:auto">
      <table id="dataTable">
        <thead><tr><th>Date</th><th>Student</th><th>Subject</th><th>Code</th><th>Standard</th><th>Rating</th><th>Notes</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="student" class="section card">
    <h3>Student View</h3>
    <div class="row" style="margin-bottom:8px">
      <select id="studentViewSelect" style="flex:1"></select>
      <button id="studentExport">Export this student</button>
    </div>
    <div style="max-height:380px;overflow:auto">
      <table id="studentTable">
        <thead><tr><th>Date</th><th>Subject</th><th>Code</th><th>Standard</th><th>Rating</th><th>Notes</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="settings" class="section card">
    <h3>Settings</h3>
    <div class="toggle" style="margin-top:8px">
      <input type="checkbox" id="hideNames">
      <label for="hideNames">Hide student names in app</label>
    </div>
    <div class="toggle" style="margin-top:8px">
      <input type="checkbox" id="useInitials">
      <label for="useInitials">Show initials instead of full name when hidden</label>
    </div>
    <div class="row" style="margin-top:12px">
      <input id="newStudentName" placeholder="Add student name" style="flex:1">
      <button id="addStudentBtn">Add</button>
      <button id="clearStudentsBtn" style="background:#2a0e12;border-color:#5e1921" class="right">Clear students</button>
    </div>
    <div class="row" style="margin-top:8px">
      <input type="file" id="studentCSV" accept=".csv">
      <button id="importStudentsBtn">Import CSV</button>
      <button id="downloadTemplateBtn" class="right">Download template</button>
    </div>
    <small class="note" id="studentCount"></small>

    <hr class="split">

    <h3>OneDrive (optional)</h3>
    <div class="row">
      <input id="onedriveClientId" placeholder="Paste your Microsoft Client ID" style="flex:1">
      <button id="saveClientId">Save</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="msLogin">Sign in with Microsoft</button>
      <button id="msLogout">Sign out</button>
      <span id="msStatus" class="note"></span>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="backupJSON">Backup data (JSON → OneDrive)</button>
      <button id="backupCSV">Backup data (CSV → OneDrive)</button>
    </div>
    <small class="note">
      Tip: Create an Azure app, enable "Accounts in any directory and personal Microsoft accounts"
      and add a Web redirect URI: YOUR_SITE_URL (e.g., https://yourname.pages.dev). Use scope:
      <code>Files.ReadWrite.AppFolder</code>. Paste the Client ID above.
    </small>
  </section>
</div>

<script>
const STANDARDS = {"meta": {"last_updated": "2025-08-15"}, "ELA": [{"code": "ELA.5.R.1.1", "desc": "Analyze how setting, events, conflict, characterization contribute to plot."}, {"code": "ELA.5.R.2.1", "desc": "Explain how text structures/features contribute to meaning."}, {"code": "ELA.5.R.3.2", "desc": "Summarize a text (literary/informational)."}, {"code": "ELA.5.C.1.3", "desc": "Write claims with reasons and relevant evidence."}], "Math": [{"code": "MA.5.NSO.2.1", "desc": "Multiply multi-digit whole numbers (standard algorithm)."}, {"code": "MA.5.FR.2.1", "desc": "Add and subtract fractions with unlike denominators."}, {"code": "MA.5.GR.3.2", "desc": "Volume of right rectangular prism using formula."}], "Science": [{"code": "SC.5.E.7.1", "desc": "Model parts of the water cycle."}, {"code": "SC.5.P.10.1", "desc": "Light travels in straight lines; reflect/refract/absorb."}, {"code": "SC.5.P.13.1", "desc": "Identify familiar forces."}]};
let SUBJECTS = Object.keys(STANDARDS).filter(k=>k!=='meta');
let STUDENTS = JSON.parse(localStorage.getItem('fl_students')||'[]'); // array of {name}
let RECORDS = JSON.parse(localStorage.getItem('fl_records')||'[]');   // no student_id
let SETTINGS = JSON.parse(localStorage.getItem('fl_settings')||'{}');
let MS_CFG = JSON.parse(localStorage.getItem('fl_ms_cfg')||'{}');     // {clientId}

const tabs = document.querySelectorAll('.tab');
const sections = document.querySelectorAll('.section');
tabs.forEach(t=>t.addEventListener('click',()=>{
  tabs.forEach(b=>b.classList.remove('active')); t.classList.add('active');
  sections.forEach(s=>s.classList.remove('active')); document.getElementById(t.dataset.tab).classList.add('active');
  if(t.dataset.tab==='records') renderTable();
  if(t.dataset.tab==='student') renderStudentView();
}));

const studentSelect = document.getElementById('studentSelect');
const subjectSelect = document.getElementById('subjectSelect');
const standardSelect = document.getElementById('standardSelect');
const standardSearch = document.getElementById('standardSearch');
const dateInput = document.getElementById('dateInput');
const notesEl = document.getElementById('notes');
const ratingGroup = document.getElementById('ratingGroup');

const filterStudent = document.getElementById('filterStudent');
const filterCode = document.getElementById('filterCode');
const filterSubject = document.getElementById('filterSubject');
const filterRating = document.getElementById('filterRating');
const tbody = document.querySelector('#dataTable tbody');

const hideNamesEl = document.getElementById('hideNames');
const useInitialsEl = document.getElementById('useInitials');
const studentCount = document.getElementById('studentCount');
const studentViewSelect = document.getElementById('studentViewSelect');
const studentTableBody = document.querySelector('#studentTable tbody');

const msStatus = document.getElementById('msStatus');
const onedriveClientId = document.getElementById('onedriveClientId');

function setToday(){ const d=new Date(); dateInput.value=d.toISOString().slice(0,10); } setToday();

function masked(name){
  if(!hideNamesEl.checked) return name;
  if(useInitialsEl.checked){
    const parts = (name||'').trim().split(/\\s+/);
    return parts.map(p=>p[0]?.toUpperCase()||'').join('');
  }
  return 'Student';
}

function renderStudents(){
  studentSelect.innerHTML = '<option value=\"\">Select student…</option>' + STUDENTS.map((s,i)=>`<option value=\"${i}\">${masked(s.name)}</option>`).join('');
  studentViewSelect.innerHTML = '<option value=\"\">Choose student…</option>' + STUDENTS.map((s,i)=>`<option value=\"${i}\">${masked(s.name)}</option>`).join('');
  studentCount.textContent = STUDENTS.length ? `${STUDENTS.length} students` : 'No students yet';
  localStorage.setItem('fl_students', JSON.stringify(STUDENTS));
}

function renderSubjects(){
  subjectSelect.innerHTML = SUBJECTS.map(s=>`<option value=\"${s}\">${s}</option>`).join('');
  filterSubject.innerHTML = '<option value=\"\">All</option>' + SUBJECTS.map(s=>`<option value=\"${s}\">${s}</option>`).join('');
}

function renderStandards(){
  const subj = subjectSelect.value;
  const list = (STANDARDS[subj]||[]);
  const q = standardSearch.value.toLowerCase();
  const filtered = list.filter(x => (x.code+' '+x.desc).toLowerCase().includes(q));
  standardSelect.innerHTML = '<option value=\"\">Select standard…</option>' + filtered.map(x=>`<option value=\"${x.code}\">${x.code} — ${x.desc}</option>`).join('');
}

// Rating buttons
ratingGroup.querySelectorAll('button').forEach(b=>b.addEventListener('click',()=>{
  ratingGroup.querySelectorAll('button').forEach(x=>x.style.borderColor='var(--line)');
  b.style.borderColor='var(--accent)';
  ratingGroup.dataset.value = b.dataset.v;
}));

function saveRecord(){
  const sIdx = studentSelect.value;
  const subj = subjectSelect.value;
  const code = standardSelect.value;
  const rating = parseInt(ratingGroup.dataset.value||'0',10);
  const note = notesEl.value.trim();
  if(sIdx==='') return alert('Choose a student');
  if(!subj) return alert('Choose a subject');
  if(!code) return alert('Choose a standard');
  if(!rating) return alert('Pick 1–5');
  const std = (STANDARDS[subj]||[]).find(x=>x.code===code);
  const rec = {date: dateInput.value, student: STUDENTS[sIdx].name, subject: subj, code, standard: std?std.desc:'', rating, notes: note};
  RECORDS.push(rec);
  localStorage.setItem('fl_records', JSON.stringify(RECORDS));
  notesEl.value=''; ratingGroup.dataset.value=''; ratingGroup.querySelectorAll('button').forEach(x=>x.style.borderColor='var(--line)');
  alert('Saved');
}

// Delete by index (from Records view)
function delRecordGlobal(idx){
  if(!confirm('Delete this record?')) return;
  RECORDS.splice(idx,1);
  localStorage.setItem('fl_records', JSON.stringify(RECORDS));
  renderTable();
}

function renderTable(){
  const fs = filterStudent.value.toLowerCase();
  const fc = filterCode.value.toLowerCase();
  const fsubj = filterSubject.value;
  const fr = filterRating.value;
  const rows = RECORDS
    .map((r,i)=>({...r, __i:i}))
    .filter(r => (!fs || r.student.toLowerCase().includes(fs)))
    .filter(r => (!fc || (r.code+' '+r.standard).toLowerCase().includes(fc)))
    .filter(r => (!fsubj || r.subject===fsubj))
    .filter(r => (!fr || String(r.rating)===fr));
  tbody.innerHTML = rows.map((r)=>`<tr>
    <td>${r.date}</td>
    <td>${masked(r.student)}</td>
    <td>${r.subject}</td>
    <td><span class="badge">${r.code}</span></td>
    <td>${r.standard}</td>
    <td><b>${r.rating}</b></td>
    <td>${r.notes||''}</td>
    <td><button onclick="delRecordGlobal(${r.__i})">Delete</button></td>
  </tr>`).join('');
  localStorage.setItem('fl_records', JSON.stringify(RECORDS));
}

// Student View (with per-row delete)
function delRecordForStudent(idxInFiltered){
  const idx = parseInt(studentViewSelect.value,10);
  if(isNaN(idx)) return;
  const target = STUDENTS[idx]?.name || '';
  const filtered = RECORDS.map((r,i)=>({r,i})).filter(x=>x.r.student===target);
  const realIndex = filtered[idxInFiltered]?.i;
  if(realIndex==null) return;
  if(!confirm('Delete this record?')) return;
  RECORDS.splice(realIndex,1);
  localStorage.setItem('fl_records', JSON.stringify(RECORDS));
  renderStudentView();
}

function renderStudentView(){
  const idx = studentViewSelect.value;
  if(idx===''){ studentTableBody.innerHTML=''; return; }
  const target = STUDENTS[idx]?.name || '';
  const rows = RECORDS.filter(r=>r.student===target);
  studentTableBody.innerHTML = rows.map((r,idx)=>`<tr>
    <td>${r.date}</td><td>${r.subject}</td><td><span class="badge">${r.code}</span></td><td>${r.standard}</td><td><b>${r.rating}</b></td><td>${r.notes||''}</td>
    <td><button onclick="delRecordForStudent(${idx})">Delete</button></td>
  </tr>`).join('');
}

// CSV helpers
function csvFrom(records){
  const header = ["date","student","subject","code","standard","rating","notes"];
  const lines = [header.join(',')].concat(records.map(r => header.map(h => '"' + String(r[h]||'').replace(/"/g,'""') + '"').join(',')));
  return lines.join('\\n');
}

function exportCSVAll(){ const blob = new Blob([csvFrom(RECORDS)], {type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='fl-standards.csv'; a.click(); }
document.getElementById('exportBtn').addEventListener('click', exportCSVAll);
document.getElementById('studentExport').addEventListener('click', ()=>{
  const idx = studentViewSelect.value; if(idx==='') return alert('Choose a student');
  const target = STUDENTS[idx]?.name || '';
  const rows = RECORDS.filter(r=>r.student===target);
  const blob = new Blob([csvFrom(rows)], {type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='fl-standards-'+(target||'student')+'.csv'; a.click();
});

// Student management
document.getElementById('addStudentBtn').addEventListener('click', ()=>{
  const name = document.getElementById('newStudentName').value.trim();
  if(!name) return alert('Enter a name');
  STUDENTS.push({name});
  document.getElementById('newStudentName').value='';
  renderStudents();
});
document.getElementById('clearStudentsBtn').addEventListener('click', ()=>{
  if(!confirm('Delete all students?')) return;
  STUDENTS = []; renderStudents();
});

// Filters
document.getElementById('filterStudent').addEventListener('input', renderTable);
document.getElementById('filterCode').addEventListener('input', renderTable);
document.getElementById('filterSubject').addEventListener('change', renderTable);
document.getElementById('filterRating').addEventListener('change', renderTable);

// Settings
hideNamesEl.addEventListener('change', ()=>{ SETTINGS.hide = hideNamesEl.checked; SETTINGS.initials = useInitialsEl.checked; localStorage.setItem('fl_settings', JSON.stringify(SETTINGS)); renderStudents(); renderTable(); renderStudentView(); });
useInitialsEl.addEventListener('change', ()=>{ SETTINGS.hide = hideNamesEl.checked; SETTINGS.initials = useInitialsEl.checked; localStorage.setItem('fl_settings', JSON.stringify(SETTINGS)); renderStudents(); renderTable(); renderStudentView(); });

// Init
function init(){
  hideNamesEl.checked = !!SETTINGS.hide;
  useInitialsEl.checked = !!SETTINGS.initials;
  renderSubjects();
  standardSearch.addEventListener('input', renderStandards);
  subjectSelect.addEventListener('change', renderStandards);
  renderStudents();
  renderStandards();
  renderTable();
}
init();

// OneDrive via MSAL + Graph
let msalInstance = null;
let msalAccount = null;
const GRAPH_SCOPES = ["Files.ReadWrite.AppFolder"];
const GRAPH_UPLOAD_URL = "https://graph.microsoft.com/v1.0/me/drive/special/approot:/FLStandards/";

function updateMsStatus(){
  const who = msalAccount ? (msalAccount.username || msalAccount.localAccountId) : "Signed out";
  msStatus.textContent = "Status: " + who;
}

window.addEventListener('load', () => {
  if(MS_CFG.clientId) onedriveClientId.value = MS_CFG.clientId;
  if (window.msal && MS_CFG.clientId) {
    msalInstance = new msal.PublicClientApplication({
      auth: { clientId: MS_CFG.clientId, authority: "https://login.microsoftonline.com/common", redirectUri: window.location.origin },
      cache: { cacheLocation: "localStorage" }
    });
    const accs = msalInstance.getAllAccounts();
    if(accs.length) { msalAccount = accs[0]; }
  }
  updateMsStatus();
});

document.getElementById('saveClientId').addEventListener('click', ()=>{
  MS_CFG.clientId = onedriveClientId.value.trim();
  localStorage.setItem('fl_ms_cfg', JSON.stringify(MS_CFG));
  alert('Saved Client ID. Reload to initialize MSAL.');
});

document.getElementById('msLogin').addEventListener('click', async ()=>{
  if(!MS_CFG.clientId) return alert('Enter and save your Microsoft Client ID first.');
  if(!msalInstance) {
    msalInstance = new msal.PublicClientApplication({
      auth: { clientId: MS_CFG.clientId, authority: "https://login.microsoftonline.com/common", redirectUri: window.location.origin },
      cache: { cacheLocation: "localStorage" }
    });
  }
  try {
    const result = await msalInstance.loginPopup({ scopes: GRAPH_SCOPES });
    msalAccount = result.account;
    updateMsStatus();
  } catch(e) { alert('Login failed: '+e); }
});

document.getElementById('msLogout').addEventListener('click', async ()=>{
  if(!msalInstance || !msalAccount) return;
  await msalInstance.logoutPopup({ account: msalAccount });
  msalAccount = null;
  updateMsStatus();
});

async function getGraphToken(){
  if(!msalInstance || !msalAccount) throw new Error('Not signed in');
  try {
    const r = await msalInstance.acquireTokenSilent({ account: msalAccount, scopes: GRAPH_SCOPES });
    return r.accessToken;
  } catch(e) {
    const r = await msalInstance.acquireTokenPopup({ scopes: GRAPH_SCOPES });
    return r.accessToken;
  }
}

async function uploadText(filename, text){
  const token = await getGraphToken();
  const url = GRAPH_UPLOAD_URL + encodeURIComponent(filename) + ':/content';
  const resp = await fetch(url, {
    method: 'PUT',
    headers: { 'Authorization': 'Bearer '+token, 'Content-Type':'text/plain' },
    body: text
  });
  if(!resp.ok) throw new Error('Upload failed: '+resp.status);
  alert('Uploaded to OneDrive: '+filename+' (App folder)');
}

document.getElementById('backupJSON').addEventListener('click', async ()=>{
  const dump = JSON.stringify({ students: STUDENTS, records: RECORDS, settings: SETTINGS }, null, 2);
  try { await uploadText('backup-'+new Date().toISOString().slice(0,10)+'.json', dump); }
  catch(e){ alert(e.message); }
});

document.getElementById('backupCSV').addEventListener('click', async ()=>{
  try { await uploadText('records-'+new Date().toISOString().slice(0,10)+'.csv', csvFrom(RECORDS)); }
  catch(e){ alert(e.message); }
});

if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js')); }

// ----- CSV Import (roster) -----
const studentCSV = document.getElementById('studentCSV');
const importStudentsBtn = document.getElementById('importStudentsBtn');
const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');

downloadTemplateBtn.addEventListener('click', ()=>{
  const tmpl = 'name\nAlice Johnson\nBob Smith\n';
  const blob = new Blob([tmpl], {type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'roster-template.csv'; a.click();
});

importStudentsBtn.addEventListener('click', async ()=>{
  const f = studentCSV.files && studentCSV.files[0];
  if(!f) return alert('Choose a CSV file first.');
  const text = await f.text();
  const rows = text.split(/\r?\n/).filter(r => r.trim().length);
  if(!rows.length) return alert('CSV is empty.');
  const headers = rows[0].split(',').map(h=>h.trim().toLowerCase());
  const nameIdx = headers.indexOf('name');
  if(nameIdx === -1) return alert('CSV must include a "name" column in the first row.');
  let added = 0;
  for(let i=1;i<rows.length;i++){
    const cols = rows[i].split(',');
    const nm = (cols[nameIdx]||'').trim();
    if(!nm) continue;
    // avoid dupes: skip if same name already exists
    if(STUDENTS.some(s => (s.name||'').trim().toLowerCase() === nm.toLowerCase())) continue;
    STUDENTS.push({name: nm});
    added++;
  }
  if(added){ renderStudents(); alert('Imported '+added+' students.'); }
  else { alert('No new students found to import.'); }
});


// === Robust CSV import (overrides previous handler) ===
(function(){
  const studentCSV = document.getElementById('studentCSV');
  const importStudentsBtn = document.getElementById('importStudentsBtn');

  function normalizeHeader(h){
    if(!h) return "";
    // strip quotes and BOM, trim, lower
    return String(h)
      .replace(/^[\"\']|[\"\']$/g,"")
      .replace(/^\uFEFF/,"")
      .trim()
      .toLowerCase();
  }

  function splitLine(line){
    // prefer comma, but if no commas and tabs exist, use tab
    if (line.indexOf(",") === -1 && line.indexOf("\t") !== -1){
      return line.split("\t");
    }
    // otherwise split on commas
    return line.split(",");
  }

  async function importRoster(){
    const f = studentCSV && studentCSV.files ? studentCSV.files[0] : null;
    if(!f){ alert('Choose a CSV file first.'); return; }
    let text = await f.text();
    // normalize newlines
    text = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
    const lines = text.split("\n").filter(r => r.trim().length);
    if(!lines.length){ alert('CSV is empty.'); return; }

    // Parse header
    let headers = splitLine(lines[0]).map(normalizeHeader);
    // if single empty header and single column of data, treat as 'name'
    if (headers.length === 1 && headers[0] === "") headers[0] = "name";

    // Find name column (accept 'name' or 'student' or 'student_name')
    let nameIdx = headers.findIndex(h => h === "name" || h === "student" || h === "student_name");
    if (nameIdx === -1){
      alert('Could not find a name column. Please include a header named "name".');
      return;
    }

    let added = 0, seen = new Set(STUDENTS.map(s => (s.name||"").trim().toLowerCase()));
    for (let i=1; i<lines.length; i++){
      const cols = splitLine(lines[i]).map(v => {
        v = v.replace(/^[\"\']|[\"\']$/g,"").replace(/^\uFEFF/,"").trim();
        return v;
      });
      const nm = (cols[nameIdx]||"").trim();
      if (!nm) continue;
      const key = nm.toLowerCase();
      if (seen.has(key)) continue;
      STUDENTS.push({name: nm});
      seen.add(key);
      added++;
    }
    renderStudents();
    alert(added ? ('Imported ' + added + ' students.') : 'No new students to import.');
  }

  // Remove old click handlers by cloning the node (cheap and safe)
  if (importStudentsBtn){
    const clone = importStudentsBtn.cloneNode(true);
    importStudentsBtn.parentNode.replaceChild(clone, importStudentsBtn);
    clone.addEventListener('click', importRoster);
  }
})();

</script>
</body>
</html>
