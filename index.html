<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KidVision Standards Tracker</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="KidVision">
<link rel="apple-touch-icon" href="icon-192.png">
<script defer src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"></script>
<style>
:root { --bg:#0a0e1a; --card:#121a32; --accent:#0ab0f5; --accent2:#ff2b75; --muted:#9fb0d0; --line:#1e2a49; }
* { box-sizing:border-box }
html,body { margin:0; height:100%; font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial; color:#e6f0ff; }
body { background: linear-gradient(135deg, #0a0e1a, #000000); background-attachment: fixed; }
body::before {
  content: "";
  position: fixed; inset: 0;
  background: url('kidvision_logo.png') center center no-repeat;
  background-size: 40%;
  opacity: 0.18; z-index: -1;
}
.app { max-width:980px; margin:0 auto; padding:14px }
header { display:flex; align-items:center; gap:8px; justify-content:space-between; margin-bottom:10px }
.brand { font-weight:800; letter-spacing:.2px }
.tabs { display:flex; gap:6px }
.tab { border:1px solid var(--line); background:#0f1832; border-radius:999px; padding:6px 10px; color:#cfe2ff; cursor:pointer }
.tab.active { background:#243152; color:#fff; border-color:#3a4a74 }
.card { background:var(--card); border:1px solid var(--line); border-radius:16px; padding:12px; box-shadow:0 10px 26px rgba(0,0,0,.25) }
.row { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
input,select,textarea,button { background:#0d152b; border:1px solid var(--line); color:#e6f0ff; border-radius:10px; padding:10px 12px; font-size:16px }
button { background: var(--accent); }
button:hover { background: var(--accent2); }
textarea { width:100%; min-height:80px }
h3 { margin:0 0 8px 0 }
small.note, small.muted { color:#9fb0d0 }
table { width:100%; border-collapse:collapse }
th,td { border-bottom:1px solid var(--line); padding:8px 6px; text-align:left; vertical-align:top }
th { position:sticky; top:0; background:#0f1832; z-index:1 }
.right { margin-left:auto }
.badge { border:1px solid var(--line); padding:2px 8px; border-radius:999px; color:#bcd1ff; font-size:12px }
.section { display:none }
.section.active { display:block }
.toggle { display:flex; align-items:center; gap:8px }
hr.split { border:0; border-top:1px solid var(--line); margin:10px 0 }

/* --- Standards dropdown overflow fix --- */
select, .dropdown {
  max-width: 100%;
  white-space: normal;         /* wrap long entries */
  overflow-wrap: break-word;
}

select {
  max-height: 220px;           /* limit height and scroll */
  overflow-y: auto;
}

select option {
  line-height: 1.2;
  padding: 6px 8px;
}
/* --- end fix --- */


/* === Supabase Access Gate (v11) === */
#gateOverlay{position:fixed;inset:0;background:rgba(5,8,18,.96);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:9999}
#gateCard{background:#151b2f;border:1px solid #26335b;border-radius:16px;padding:16px;max-width:480px;width:92%;box-shadow:0 15px 40px rgba(0,0,0,.45);}
#gateCard h2{margin:0 0 8px 0}
#gateCard p{color:#9fb0d0;margin:0 0 12px 0}
#gateCard input{width:100%;margin:6px 0 10px 0;background:#0e1630;border:1px solid #26335b;color:#e6f0ff;border-radius:10px;padding:10px 12px}
#gateCard button{width:100%;padding:10px 14px;border-radius:12px;background:#0ab0f5;border:1px solid #3a9dd4;color:#fff;font-weight:600}
#gateCard small{display:block;color:#9fb0d0;margin-top:8px;text-align:center}
#gateErr{color:#ff6f91;min-height:18px;margin-bottom:6px}

</style>
</head>
<body>

<div id="gateOverlay">
  <div id="gateCard">
    <h2>Restricted Access</h2>
    <p>Enter your email and invite code to continue.</p>
    <div id="gateErr"></div>
    <input id="gateEmail" placeholder="Your email">
    <input id="gateCode" placeholder="Invite code">
    <button id="gateSubmit">Unlock</button>
    <small>Need access? Contact the owner.</small>
  </div>
</div>

<div class="app">
  <header>
    <div class="row">
      <span class="brand">KidVision Standards Tracker</span>
      <span class="badge">Local & Offline</span>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="quick">Quick Rate</button>
      <button class="tab" data-tab="records">Records</button>
      <button class="tab" data-tab="student">Student View</button>
      <button class="tab" data-tab="settings">Settings</button>
    </div>
  </header>

  <section id="quick" class="section active card">
    <h3>Quick Rate</h3>
    <div class="row">
      <select id="studentSelect" style="flex:1"></select>
      <select id="subjectSelect" style="flex:1"></select>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="standardSearch" placeholder="Search standard (code or text)…" style="flex:1">
      <select id="standardSelect" style="flex:1"></select>
    </div>
    <div class="row" style="margin-top:8px">
      <select id="subskillSelect" style="flex:1" disabled>
        <option value="">Select subskill…</option>
      </select>
      <div id="ratingGroup" class="row">
        <button data-v="1">1</button><button data-v="2">2</button><button data-v="3">3</button><button data-v="4">4</button><button data-v="5">5</button>
      </div>
      <input id="dateInput" type="date" class="right">
    </div>
    <textarea id="notes" placeholder="Notes / evidence / accommodations…"></textarea>
    <div class="row" style="margin-top:8px">
      <button id="saveBtn">Save</button>
      <small class="muted">5 = Proficient · 1 = Not proficient</small>
    </div>
  </section>

  <section id="records" class="section card">
    <h3>Records</h3>
    <div class="row" style="margin:8px 0">
      <input id="filterStudent" placeholder="Filter by student…" style="flex:1">
      <input id="filterCode" placeholder="Filter by code/text/subskill…" style="flex:1">
      <select id="filterSubject"></select>
      <select id="filterRating">
        <option value="">All</option><option>5</option><option>4</option><option>3</option><option>2</option><option>1</option>
      </select>
      <button id="exportBtn" class="right">Export CSV</button>
    </div>
    <div style="max-height:420px;overflow:auto">
      <table id="dataTable">
        <thead><tr><th>Date</th><th>Student</th><th>Subject</th><th>Code</th><th>Standard</th><th>Subskill</th><th>Rating</th><th>Notes</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="student" class="section card">
    <h3>Student View</h3>
    <div class="row" style="margin-bottom:8px">
      <select id="studentViewSelect" style="flex:1"></select>
      <button id="studentExport">Export this student</button>
    </div>
    <div style="max-height:420px;overflow:auto">
      <table id="studentTable">
        <thead><tr><th>Date</th><th>Subject</th><th>Code</th><th>Standard</th><th>Subskill</th><th>Rating</th><th>Notes</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="settings" class="section card">
    <h3>Settings</h3>

    <div class="toggle">
      <input type="checkbox" id="hideNames">
      <label for="hideNames">Hide student names in app</label>
    </div>
    <div class="toggle" style="margin-top:8px">
      <input type="checkbox" id="useInitials">
      <label for="useInitials">Show initials instead of full name when hidden</label>
    </div>

    <div class="row" style="margin-top:12px">
      <input id="newStudentName" placeholder="Add student name" style="flex:1">
      <button id="addStudentBtn">Add</button>
      <button id="clearStudentsBtn" style="background:#2a0e12;border-color:#5e1921" class="right">Clear students</button>
    </div>
    <div class="row" style="margin-top:8px">
      <input type="file" id="studentCSV" accept=".csv">
      <button id="importStudentsBtn">Import CSV</button>
      <button id="downloadTemplateBtn" class="right">Download template</button>
    </div>
    <small class="note" id="studentCount"></small>

    <hr class="split">

    <h3>Local folder (optional)</h3>
    <div class="row" style="align-items:center">
      <button id="pickDirBtn">Choose folder</button>
      <span id="pickedDirLabel" class="note"></span>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="saveJSONLocal">Save all → JSON</button>
      <button id="saveCSVLocal">Save all → CSV</button>
      <label class="toggle"><input type="checkbox" id="autoSaveLocal"> Auto‑save after each record</label>
    </div>

    <hr class="split">

    <h3>OneDrive (optional)</h3>
    <div class="row">
      <input id="onedriveClientId" placeholder="Paste your Microsoft App (client) ID" style="flex:1">
      <button id="saveClientId">Save</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="msLogin">Sign in with Microsoft</button>
      <button id="msLogout">Sign out</button>
      <span id="msStatus" class="note"></span>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="backupJSON">Backup data (JSON → OneDrive)</button>
      <button id="backupCSV">Backup data (CSV → OneDrive)</button>
    </div>
    <small class="note">Scope: <code>Files.ReadWrite.AppFolder</code>. Redirect URI = your site URL.</small>
  
    <hr class="split">
    <h3>Access control (Supabase)</h3>
    <div class="row">
      <input id="sbUrl" placeholder="Supabase URL" style="flex:1">
      <input id="sbKey" placeholder="Supabase anon public key" type="password" style="flex:1">
      <button id="saveSb">Save</button>
    </div>
    <small class="note">Paste your Supabase project URL and anon key. Codes are managed in the <code>invite_codes</code> table.</small>

  </section>
</div>

<script>
const STANDARDS = {"Reading": [{"code": "ELA.5.R.1.1", "desc": "Analyze how setting, events, conflict, and characterization contribute to the plot in a literary text.", "subskills": ["Read science fiction with illustrations (5)", "Use actions and dialogue to understand characters (5-C.1)", "Compare and contrast characters (5-C.2)", "Identify story elements (5-I.2)", "Read fantasy with illustrations (5-M.1)", "Read realistic fiction with illustrations (5-M.2)", "Read historical fiction with illustrations (5-M.3)", "Read realistic fiction (5-N.1)", "Read historical fiction (5-N.2)", "Read poetry (5-N.3)", "Read drama (5-N.4)", "Summarize a story (5-S.1)", "Identify supporting details in literary texts (5-T.4)", "Show character emotions and traits (5-U.1)"]}, {"code": "ELA.5.R.1.2", "desc": "Explain the development of stated or implied theme(s) throughout a literary text.", "subskills": ["Determine the themes of short stories (5-B.1)"]}, {"code": "ELA.5.R.1.3", "desc": "Describe how an author develops a character's perspective in a literary text.", "subskills": ["Use actions and dialogue to understand characters (5-C.1)", "Identify the narrative point of view (5-I.1)"]}, {"code": "ELA.5.R.1.4", "desc": "Explain how figurative language and other poetic elements work together in a poem.", "subskills": ["Identify similes and metaphors (5-H.1)", "Similes and metaphors with pictures (5-H.2)", "Determine the meanings of similes and metaphors (5-H.3)", "Interpret the meaning of an allusion from its source (5-H.4)", "Analyze the effects of figures of speech on meaning and tone (5-H.5)", "Label the rhyme scheme (5-L.1)", "Identify elements of poetry (5-L.2)", "Read poetry (5-N.3)", "Classify figures of speech (5)"]}, {"code": "ELA.5.R.2.1", "desc": "Explain how text structures and/or features contribute to the overall meaning of texts.", "subskills": ["Determine the order of events in informational texts (5-F.1)", "Compare and contrast in informational texts (5-F.2)", "Match causes and effects in informational texts (5-F.3)", "Match problems with their solutions (5-F.4)", "Identify text structures (5-F.5)", "Read graphic organizers (5-J.2)", "Select and use text features (5-K.1)"]}, {"code": "ELA.5.R.2.2", "desc": "Explain how relevant details support the central idea(s), implied or explicit.", "subskills": ["Use key details to determine the central idea (5)", "Read about animals (5-O.1)", "Read about art, music, and traditions (5-O.2)", "Read about famous places (5-O.3)", "Read about sports and hobbies (5-O.4)", "Read about famous people (5-P.1)", "Read about business and technology (5-P.2)", "Read about science and nature (5-P.3)", "Read about history (5-P.4)", "Identify supporting details in informational texts (5-T.5)", "Determine the central idea of a passage (5)", "Combine central ideas from two texts (5)"]}, {"code": "ELA.5.R.2.3", "desc": "Analyze an author's purpose and/or perspective in an informational text.", "subskills": ["Identify the purpose of a text (5-D.1)", "Compare information from two texts (5-E.2)"]}, {"code": "ELA.5.R.2.4", "desc": "Track the development of an argument, identifying the specific claim(s), evidence, and reasoning.", "subskills": ["Identify an author's statement of opinion (5-T.2)", "Choose reasons to support an opinion (5-T.3)", "Identify supporting details in informational texts (5-T.5)", "Identify counterclaims (5)", "Trace an argument (5)", "Classify logical fallacies (5)"]}, {"code": "ELA.5.R.3.1", "desc": "Analyze how figurative language contributes to meaning in text(s).", "subskills": ["Determine the meanings of similes and metaphors (5-H.3)", "Interpret the meaning of an allusion from its source (5-H.4)", "Analyze the effects of figures of speech on meaning and tone (5-H.5)", "Determine the meaning of idioms from context: set 1 (5-EE.1)", "Identify the meaning of idioms and adages: set 1 (5-EE.2)", "Determine the meaning of idioms from context: set 2 (5-EE.3)", "Identify the meaning of idioms and adages: set 2 (5-EE.4)", "Classify figures of speech (5)", "Use personification (5)"]}, {"code": "ELA.5.R.3.2", "desc": "Summarize a text to enhance comprehension.", "subskills": ["Read science fiction with illustrations (5)", "Determine the themes of short stories (5-B.1)", "Identify story elements (5-I.2)", "Read fantasy with illustrations (5-M.1)", "Read realistic fiction with illustrations (5-M.2)", "Read historical fiction with illustrations (5-M.3)", "Read realistic fiction (5-N.1)", "Read historical fiction (5-N.2)", "Read poetry (5-N.3)", "Read drama (5-N.4)", "Summarize a story (5-S.1)", "Use key details to determine the central idea (5)", "Read about animals (5-O.1)", "Read about art, music, and traditions (5-O.2)", "Read about famous places (5-O.3)", "Read about sports and hobbies (5-O.4)", "Read about famous people (5-P.1)", "Read about business and technology (5-P.2)", "Read about science and nature (5-P.3)", "Read about history (5-P.4)", "Identify supporting details in informational texts (5-T.5)", "Determine the central idea of a passage (5)", "Trace an argument (5)"]}, {"code": "ELA.5.R.3.3", "desc": "Compare and contrast primary and secondary sources related to the same topic.", "subskills": ["Compare and contrast points of view (5-E.1)", "Compare information from two texts (5-E.2)", "Compare mythological illustrations (5-J.1)"]}], "Math": [{"code": "MA.5.NSO.1.1", "desc": "Express how the value of a digit in a multi-digit number with decimals to the thousandths changes if the digit moves one or more places to the left or right.", "subskills": ["Place values in decimal numbers (5-W.4)", "Relationship between decimal place values (5-W.5)"]}, {"code": "MA.5.NSO.1.2", "desc": "Read and write multi-digit numbers with decimals to the thousandths using standard form, word form and expanded form.", "subskills": ["Understanding decimals expressed in words (5-W.3)", "Convert decimals between standard and expanded form (5-W.6)", "Convert decimals between standard and expanded form using fractions (5-W.7)"]}, {"code": "MA.5.NSO.1.3", "desc": "Compose and decompose multi-digit numbers with decimals to the thousandths in multiple ways using the values of the digits in each place. Demonstrate the compositions or decompositions using objects, drawings and expressions or equations.", "subskills": ["What decimal number is illustrated? (5-W.1)", "Place values in decimal numbers (5-W.4)", "Compose and decompose decimals in multiple ways (5-W.8)"]}, {"code": "MA.5.NSO.1.4", "desc": "Plot, order and compare multi-digit numbers with decimals up to the thousandths.", "subskills": ["Decimal number lines (5-W.10)", "Compare decimals using grids (5-X.2)", "Compare decimals on number lines (5-X.3)", "Compare decimal numbers (5-X.4)", "Put decimal numbers in order (5-X.5)"]}, {"code": "MA.5.NSO.1.5", "desc": "Round multi-digit numbers with decimals to the thousandths to the nearest hundredth, tenth or whole number.", "subskills": ["Round decimals (5-W.9)", "Compare, order, and round decimals: word problems (5-X.6)", "Estimate sums and differences of decimals using rounding (5-AA.13)"]}, {"code": "MA.5.NSO.2.1", "desc": "Multiply multi-digit whole numbers including using a standard algorithm with procedural fluency.", "subskills": ["Multiply by 1-digit numbers (5-D.7)", "Multiply by 1-digit numbers: word problems (5-D.8)", "Multiply by 2-digit numbers: complete the missing steps (5-D.9)", "Multiply 2-digit numbers by 2-digit numbers (5-D.10)", "Multiply 2-digit numbers by 3-digit numbers (5-D.11)", "Multiply 2-digit numbers by larger numbers (5-D.12)", "Multiply by 2-digit numbers: word problems (5-D.13)", "Multiply by 3-digit numbers (5-D.14)"]}, {"code": "MA.5.NSO.2.2", "desc": "Divide multi-digit whole numbers, up to five digits by two digits, including using a standard algorithm with procedural fluency. Represent remainders as fractions.", "subskills": ["Divide by 2-digit numbers: estimate and adjust (5-E.9)", "Divide by 2-digit numbers using models (5-E.10)", "Divide by 2-digit numbers using partial quotients (5-E.11)", "Divide 2-digit and 3-digit numbers by 2-digit numbers (5-E.12)", "Divide 4-digit numbers by 2-digit numbers (5-E.14)", "Choose numbers with a particular quotient (5-E.19)", "Divide 3-digit numbers by 2-digit numbers: write remainders as fractions (5)", "Divide 5-digit numbers by 2-digit numbers (5)", "Divide 4-digit and 5-digit numbers by 2-digit numbers: write remainders as fractions (5)", "Divide by 2-digit numbers: word problems (5)"]}, {"code": "MA.5.NSO.2.3", "desc": "Add and subtract multi-digit numbers with decimals to the thousandths, including using a standard algorithm with procedural fluency.", "subskills": ["Use properties to add three decimals (5-AA.3)", "Add and subtract decimal numbers (5)", "Use compensation to add and subtract decimals (5-AA.7)", "Add and subtract decimal numbers: word problems (5)", "Choose decimals with a particular sum or difference (5)", "Add and subtract money amounts (5-HH.1)", "Add and subtract money: word problems (5-HH.2)", "Add decimal numbers: up to thousandths (5)", "Subtract decimal numbers: up to thousandths (5)", "Complete the decimal addition or subtraction sentence (5)"]}, {"code": "MA.5.NSO.2.4", "desc": "Explore the multiplication and division of multi-digit numbers with decimals to the hundredths using estimation, rounding and place value.", "subskills": ["Multiply a decimal by a power of ten (5-BB.1)", "Multiply by a power of ten with decimals: find the missing number (5-BB.4)", "Multiply a decimal by a one-digit whole number: tenths or hundredths (5-CC.2)", "Multiply a decimal by a one-digit whole number using blocks (5-CC.3)", "Multiply a decimal by a one-digit whole number using the distributive property (5-CC.4)", "Multiply a decimal by a one-digit whole number (5-CC.5)", "Multiply a decimal by a two-digit whole number using area models (5-CC.6)", "Estimate products of decimals (5-DD.1)", "Multiply decimals less than one using grids (5-DD.2)", "Multiply decimals using grids (5-DD.3)", "Multiply two decimals: where does the decimal point go? (5-DD.4)", "Multiply decimals using area models (5-DD.5)", "Multiply two decimals: products up to hundredths (5-DD.6)", "Divide by powers of ten (5-EE.1)", "Decimal division patterns over increasing place values (5-EE.2)", "Divide by a power of ten with decimals: find the missing number (5-EE.5)", "Estimate decimal quotients (5-FF.1)", "Divide decimals using blocks: complete the equation (5-FF.2)", "Divide decimals using area models: complete the equation (5-FF.3)", "Divide decimals by whole numbers using place value (5-FF.4)", "Divide decimals by whole numbers without adding zeros (5-FF.5)", "Division with decimal quotients (5-FF.6)", "Divide by decimals using place value (5-FF.9)"]}, {"code": "MA.5.NSO.2.5", "desc": "Multiply and divide a multi-digit number with decimals to the tenths by one-tenth and one-hundredth with procedural reliability.", "subskills": ["Multiply by 0.1 or 0.01 (5-BB.3)", "Divide by 0.1 or 0.01 (5)", "Multiply and divide decimals by 0.1 and 0.01 (5)", "FR Fractions"]}, {"code": "MA.5.FR.1.1", "desc": "Given a mathematical or real-world problem, represent the division of two whole numbers as a fraction.", "subskills": ["Understand fractions as division: word problems (5-T.2)", "Fractions of a whole: word problems (5)"]}, {"code": "MA.5.FR.2.1", "desc": "Add and subtract fractions with unlike denominators, including mixed numbers and fractions greater than 1, with procedural reliability.", "subskills": ["Estimate sums and differences of fractions using benchmarks (5-L.1)", "Add fractions with unlike denominators using models (5-L.2)", "Add fractions with unlike denominators (5-L.3)", "Subtract fractions with unlike denominators using models (5-L.4)", "Subtract fractions with unlike denominators (5-L.5)", "Add 3 or more fractions with unlike denominators (5-L.8)", "Complete addition and subtraction sentences with fractions (5-L.10)", "Add mixed numbers with unlike denominators (5-M.3)", "Subtract mixed numbers with unlike denominators (5-M.4)", "Complete addition and subtraction sentences with mixed numbers (5-M.9)"]}, {"code": "MA.5.FR.2.2", "desc": "Extend previous understanding of multiplication to multiply a fraction by a fraction, including mixed numbers and fractions greater than 1, with procedural reliability.", "subskills": ["Multiply two unit fractions using models (5-N.7)", "Multiply two fractions using models (5-N.8)", "Multiply fractions greater than one using models (5-N.9)", "Multiply two fractions (5-P.1)", "Complete the fraction multiplication sentence I (5-P.4)", "Complete the fraction multiplication sentence II (5-P.5)", "Multiply a mixed number by a fraction (5-R.3)", "Multiply two mixed numbers (5-R.4)"]}, {"code": "MA.5.FR.2.3", "desc": "When multiplying a given number by a fraction less than 1 or a fraction greater than 1, predict and explain the relative size of the product to the given number without calculating.", "subskills": ["Estimate products of mixed numbers (5-R.1)", "Scaling whole numbers by fractions: justify your answer (5-S.1)", "Scaling whole numbers by fractions (5-S.2)", "Scaling fractions by fractions (5-S.3)", "Scaling mixed numbers by fractions (5-S.4)"]}, {"code": "MA.5.FR.2.4", "desc": "Extend previous understanding of division to explore the division of a unit fraction by a whole number and a whole number by a unit fraction.", "subskills": ["Divide unit fractions by whole numbers using models (5-T.3)", "Divide whole numbers by unit fractions using models (5-T.5)", "Divide unit fractions and whole numbers using area models (5-T.7)", "Divide unit fractions and whole numbers using number lines (5-T.8)", "Divide unit fractions by whole numbers (5-U.1)", "Divide whole numbers by unit fractions (5-U.2)", "Divide unit fractions and whole numbers (5-U.3)", "AR Algebraic Reasoning"]}, {"code": "MA.5.AR.1.1", "desc": "Solve multi-step real-world problems involving any combination of the four operations with whole numbers, including problems in which remainders must be interpreted within the context.", "subskills": ["Represent multi-step problems using equations (5-I.3)", "Multi-step word problems (5-I.4)", "Multi-step word problems involving remainders (5-I.5)", "Multi-step word problems: identify reasonable answers (5-I.6)", "Multi-step word problems: multiplicative comparison (5-I.7)"]}, {"code": "MA.5.AR.1.2", "desc": "Solve real-world problems involving the addition, subtraction or multiplication of fractions, including mixed numbers and fractions greater than 1.", "subskills": ["Add and subtract fractions with unlike denominators: word problems (5-L.7)", "Add 3 or more fractions: word problems (5-L.9)", "Add and subtract mixed numbers: word problems (5-M.6)", "Add and subtract fractions and mixed numbers in recipes (5-M.7)", "Add and subtract fractions and mixed numbers: multi-step word problems (5-M.8)", "Multiply fractions by whole numbers: word problems (5-O.3)", "Multiply two fractions: word problems (5-P.2)", "Multiplication with mixed numbers: word problems (5-R.7)", "Multiply fractions and mixed numbers in recipes (5-R.8)", "Multiply fractions and mixed numbers: multi-step word problems (5-R.9)"]}, {"code": "MA.5.AR.1.3", "desc": "Solve real-world problems involving division of a unit fraction by a whole number and a whole number by a unit fraction.", "subskills": ["Divide unit fractions and whole numbers: word problems (5-U.4)", "Multi-step word problems with fractions and mixed numbers (5-V.3)"]}, {"code": "MA.5.AR.2.1", "desc": "Translate written real-world and mathematical descriptions into numerical expressions and numerical expressions into written mathematical descriptions.", "subskills": ["Write numerical expressions: one operation (5-H.1)", "Write numerical expressions: two operations (5-H.2)", "Comparison statements with numerical expressions (5-H.10)", "Write numerical expressions for word problems (5-I.1)", "Use numerical expressions to solve multi-step word problems (5-I.2)"]}, {"code": "MA.5.AR.2.2", "desc": "Evaluate multi-step numerical expressions using order of operations.", "subskills": ["Evaluate numerical expressions (5-H.3)", "Evaluate numerical expressions with parentheses (5-H.4)", "Evaluate numerical expressions with parentheses in different places (5-H.7)", "Evaluate numerical expressions with fractions (5-H.8)"]}, {"code": "MA.5.AR.2.3", "desc": "Determine and explain whether an equation involving any of the four operations is true or false.", "subskills": ["Identify mistakes involving the order of operations (5-H.6)", "Equations with mixed operations: true or false (5-GG.4)", "Mixed operation equations with whole numbers: true or false (5)"]}, {"code": "MA.5.AR.2.4", "desc": "Given a mathematical or real-world context, write an equation involving any of the four operations to determine the unknown whole number with the unknown in any position.", "subskills": ["Use equations to solve multi-step word problems (5)", "Represent multi-step problems using equations (5-I.3)", "Write variable equations: word problems (5-MM.4)"]}, {"code": "MA.5.AR.3.1", "desc": "Given a numerical pattern, identify and write a rule that can describe the pattern as an expression.", "subskills": ["Compare patterns (5-KK.2)", "Input/output tables: find the rule (5)"]}, {"code": "MA.5.AR.3.2", "desc": "Given a rule for a numerical pattern, use a two-column table to record the inputs and outputs.", "subskills": ["Complete a table for a two-variable relationship (5-MM.6)", "Use an expression to complete a table (5)", "Use a rule to complete an input/output table (5)", "Use an expression to complete a table and a graph (5)", "M Measurement"]}, {"code": "MA.5.M.1.1", "desc": "Solve multi-step real-world problems that involve converting measurement units to equivalent measurements within a single system of measurement.", "subskills": ["Compare and convert customary units of length (5-II.1)", "Compare and convert customary units of weight (5-II.2)", "Compare and convert customary units of volume (5-II.3)", "Compare and convert customary units (5-II.4)", "Conversion tables - customary units (5-II.5)", "Compare customary units by multiplying (5-II.6)", "Convert customary units involving fractions (5-II.7)", "Convert mixed customary units (5-II.8)", "Add and subtract mixed customary units (5-II.9)", "Multi-step problems with customary unit conversions (5-II.10)", "Compare and convert metric units of length (5-JJ.1)", "Compare and convert metric units of mass (5-JJ.2)", "Compare and convert metric units of volume (5-JJ.3)", "Compare and convert metric units (5-JJ.4)", "Conversion tables - metric units (5-JJ.5)", "Convert metric mixed units (5-JJ.6)", "Add and subtract metric mixed units (5-JJ.7)", "Multi-step problems with metric unit conversions (5-JJ.8)", "Multi-step problems with customary or metric unit conversions (5-JJ.9)", "Convert metric units involving decimals (5)"]}, {"code": "MA.5.M.2.1", "desc": "Solve multi-step real-world problems involving money using decimal notation.", "subskills": ["Add and subtract money: word problems (5-HH.2)", "Add and subtract money: multi-step word problems (5-HH.3)", "Price lists (5-HH.9)", "Unit prices (5-HH.10)", "GR Geometric Reasoning"]}, {"code": "MA.5.GR.1.1", "desc": "Classify triangles or quadrilaterals into different categories based on shared defining attributes. Explain why a triangle or quadrilateral would or would not belong to a category.", "subskills": ["Acute, obtuse, and right triangles (5-PP.1)", "Scalene, isosceles, and equilateral triangles (5-PP.2)", "Classify triangles (5-PP.3)", "Parallel sides in quadrilaterals (5-QQ.1)", "Identify parallelograms (5-QQ.2)", "Identify rectangles (5-QQ.4)", "Identify rhombuses (5-QQ.5)", "Identify trapezoids (5)", "Classify quadrilaterals (5)", "Identify the relationships between quadrilaterals (5)", "Describe relationships among quadrilaterals (5)"]}, {"code": "MA.5.GR.1.2", "desc": "Identify and classify three-dimensional figures into categories based on their defining attributes. Figures are limited to right pyramids, right prisms, right circular cylinders, right circular cones and spheres.", "subskills": ["Identify three-dimensional figures (5)", "Count vertices, edges, and faces (5)", "Attributes of three-dimensional figures (5)", "Sort three-dimensional figures (5)"]}, {"code": "MA.5.GR.2.1", "desc": "Find the perimeter and area of a rectangle with fractional or decimal side lengths using visual models and formulas.", "subskills": ["Understand fraction multiplication and area (5-P.6)", "Multiply fractions to find area (5-P.7)", "Area of squares and rectangles (5-TT.1)", "Area of rectangles with fractions (5-TT.2)", "Area of rectangles with fractions and mixed numbers (5-TT.3)", "Area and perimeter of rectangles with decimals (5-TT.)", "Perimeter of rectangles with fractional side lengths (5)"]}, {"code": "MA.5.GR.3.1", "desc": "Explore volume as an attribute of three-dimensional figures by packing them with unit cubes without gaps. Find the volume of a right rectangular prism with whole-number side lengths by counting unit cubes.", "subskills": ["Volume of rectangular prisms made of unit cubes (5-UU.3)"]}, {"code": "MA.5.GR.3.2", "desc": "Find the volume of a right rectangular prism with whole-number side lengths using a visual model and a formula.", "subskills": ["Volume of rectangular prisms made of unit cubes: expressions (5-UU.2)", "Volume of cubes and rectangular prisms (5-UU.5)"]}, {"code": "MA.5.GR.3.3", "desc": "Solve real-world problems involving the volume of right rectangular prisms, including problems with an unknown edge length, with whole-number edge lengths using a visual model or a formula. Write an equation with a variable for the unknown to represent the problem.", "subskills": ["Volume of cubes and rectangular prisms: word problems (5-UU.6)", "Volume of cubes and rectangular prisms: multi-step word problems (5-UU.8)"]}, {"code": "MA.5.GR.4.1", "desc": "Identify the origin and axes in the coordinate system. Plot and label ordered pairs in the first quadrant of the coordinate plane.", "subskills": ["Describe the coordinate plane (5-LL.1)", "Objects on a coordinate plane (5-LL.2)", "Graph points on a coordinate plane (5-LL.3)"]}, {"code": "MA.5.GR.4.2", "desc": "Represent mathematical and real-world problems by plotting points in the first quadrant of the coordinate plane and interpret coordinate values of points in the context of the situation.", "subskills": ["Graph points from a table (5-LL.5)", "Coordinate planes as maps (5-LL.8)", "Follow directions on a coordinate plane (5-LL.9)", "DP Data Analysis and Probability"]}, {"code": "MA.5.DP.1.1", "desc": "Collect and represent numerical data, including fractional and decimal values, using tables, line graphs or line plots.", "subskills": ["Create and interpret frequency tables with numerical data (5)", "Create line plots with fractions (5-NN.2)", "Create and interpret line plots with fractions (5-NN.3)", "Create line graphs (5-NN.5)"]}, {"code": "MA.5.DP.1.2", "desc": "Interpret numerical data, with whole-number values, represented with tables or line plots by determining the mean, mode, median or range.", "subskills": ["Find the mean, median, mode, or range from a list of whole numbers (5)", "Find the mean, median, mode, or range from a table or line plot (5)", "Find the mean from a table (5)", "Find the mean, median, mode, or range from a table (5)", "Find the mean, median, mode, or range from a line plot (5)"]}], "Science": [{"code": "SC.5.E.5.1", "desc": "Recognize that a galaxy consists of gas, dust, and many stars, including any objects orbiting the stars. Identify our home galaxy as the Milky Way.", "subskills": []}, {"code": "SC.5.E.5.2", "desc": "Recognize the major common characteristics of all planets and compare/contrast the properties of inner and outer planets.", "subskills": ["Analyze data to compare properties of planets (6-HH.7)"]}, {"code": "SC.5.E.5.3", "desc": "Distinguish among the following objects of the Solar System \u2014 Sun, planets, moons, asteroids, comets \u2014 and identify Earth's position in it.", "subskills": ["Identify the planets in the solar system (5-Y.10)", "Analyze models of the Earth-Sun-Moon system (6-HH.1)", "Analyze data to compare properties of planets (6-HH.7)"]}, {"code": "SC.5.E.7.1", "desc": "Create a model to explain the parts of the water cycle. Water can be a gas, a liquid, or a solid and can go back and forth from one state to another.", "subskills": ["Label parts of water cycle diagrams (5-W.2)", "Select parts of water cycle diagrams (5-W.3)"]}, {"code": "SC.5.E.7.2", "desc": "Recognize that the ocean is an integral part of the water cycle and is connected to all of Earth's water reservoirs via evaporation and precipitation processes.", "subskills": ["Describe and graph water on Earth (5-W.1)", "Label parts of water cycle diagrams (5-W.2)", "Select parts of water cycle diagrams (5-W.3)"]}, {"code": "SC.5.E.7.3", "desc": "Recognize how air temperature, barometric pressure, humidity, wind speed and direction, and precipitation determine the weather in a particular place and time.", "subskills": ["What's the difference between weather and climate? (5-V.2)", "Weather and climate around the world (5-V.3)", "Weather or climate? Cite text (5-V.4)"]}, {"code": "SC.5.E.7.4", "desc": "Distinguish among the various forms of precipitation (rain, snow, sleet, and hail), making connections to the weather in a particular place and time.", "subskills": []}, {"code": "SC.5.E.7.5", "desc": "Recognize that some of the weather-related differences, such as temperature and humidity, are found among different environments, such as swamps, deserts, and mountains.", "subskills": ["Use data to describe climates (5-V.6)"]}, {"code": "SC.5.E.7.6", "desc": "Describe characteristics (temperature and precipitation) of different climate zones as they relate to latitude, elevation, and proximity to bodies of water.", "subskills": ["Use data to describe climates (5-V.6)", "Factors affecting climate: latitude (5)", "Factors affecting climate: altitude (5)", "Factors affecting climate: distance from the ocean (5)"]}, {"code": "SC.5.E.7.7", "desc": "Design a family preparedness plan for natural disasters and identify the reasons for having such a plan.", "subskills": ["Identify the best design solution to prevent hurricane damage (5-Z.2)"]}, {"code": "SC.5.L.14.1", "desc": "Identify the organs in the human body and describe their functions, including the skin, brain, heart, lungs, stomach, liver, intestines, pancreas, muscles and skeleton, reproductive organs, kidneys, bladder, and sensory organs.", "subskills": ["Human organs and their functions (5-M.3)", "Body systems: circulation and respiration (5-M.4)", "Body systems: digestion (5-M.5)", "Body systems: removing waste (5-M.6)", "Body systems: perception and motion (5-M.7)"]}, {"code": "SC.5.L.14.2", "desc": "Compare and contrast the function of organs and other physical structures of plants and animals, including humans, for example: some animals have skeletons for support \u2014 some with internal skeletons others with exoskeletons \u2014 while some plants have stems for support.", "subskills": ["Identify vertebrates and invertebrates (5-K.2)", "Use evidence to classify mammals, birds, fish, reptiles, and amphibians (5-K.3)", "Use evidence to classify animals (5-K.4)", "Human organs and their functions (5-M.3)", "Body systems: circulation and respiration (5-M.4)", "Body systems: digestion (5-M.5)", "Body systems: removing waste (5-M.6)", "Body systems: perception and motion (5-M.7)", "Classify fruits and vegetables as plant parts (5-N.1)", "Identify plant parts and their functions (5-N.2)", "Identify flower parts and their functions (5-N.4)", "Identify the photosynthetic organism (5-N.7)"]}, {"code": "SC.5.L.15.1", "desc": "Describe how, when the environment changes, differences between individuals allow some plants and animals to survive and reproduce while others die or move to new locations.", "subskills": ["Animal adaptations: beaks, mouths, and necks (5-O.1)", "Animal adaptations: feet and limbs (5-O.2)", "Animal adaptations: skins and body coverings (5-O.3)"]}, {"code": "SC.5.L.17.1", "desc": "Compare and contrast adaptations displayed by animals and plants that enable them to survive in different environments such as life cycles variations, animal behaviors and physical characteristics.", "subskills": ["Read and construct animal life cycle diagrams (5-M.1)", "Compare animal life cycles (5-M.2)", "Flowering plant and conifer life cycles (5-N.5)", "Moss and fern life cycles (5-N.6)", "Animal adaptations: beaks, mouths, and necks (5-O.1)", "Animal adaptations: feet and limbs (5-O.2)", "Animal adaptations: skins and body coverings (5-O.3)"]}, {"code": "SC.5.P.8.1", "desc": "Compare and contrast the basic properties of solids, liquids, and gases, such as mass, volume, color, texture, and temperature.", "subskills": ["Identify and sort solids, liquids, and gases (5)"]}, {"code": "SC.5.P.8.2", "desc": "Investigate and identify materials that will dissolve in water and those that will not and identify the conditions that will speed up or slow down the dissolving process.", "subskills": []}, {"code": "SC.5.P.8.3", "desc": "Demonstrate and explain that mixtures of solids can be separated based on observable properties of their parts such as particle size, shape, color, and magnetic attraction.", "subskills": ["Identify mixtures (5-D.3)"]}, {"code": "SC.5.P.8.4", "desc": "Explore the scientific theory of atoms (also called atomic theory) by recognizing that all matter is composed of parts that are too small to be seen without magnification.", "subskills": []}, {"code": "SC.5.P.9.1", "desc": "Investigate and describe that many physical and chemical changes are affected by temperature.", "subskills": ["Heating, cooling, and changes of state (5-C.3)", "Compare physical and chemical changes (5-D.1)"]}, {"code": "SC.5.P.10.1", "desc": "Investigate and describe some basic forms of energy, including light, heat, sound, electrical, chemical, and mechanical.", "subskills": ["How are temperature and mass related to thermal energy? (5-C.6)"]}, {"code": "SC.5.P.10.2", "desc": "Investigate and explain that energy has the ability to cause motion or create change.", "subskills": ["How are speed and energy related? (5-F.4)", "Use tables and graphs to identify patterns about kinetic energy (6-H.2)", "Explore energy transformations: roller coaster ride (6-H.3)", "Explore energy transformations: bike ride (6-H.4)"]}, {"code": "SC.5.P.10.3", "desc": "Investigate and explain that an electrically-charged object can attract an uncharged object and can either attract or repel another charged object without any contact between the objects.", "subskills": ["Identify magnets that attract or repel (5-G.1)", "Label magnets that attract or repel (5-G.2)", "Compare magnitudes of magnetic forces (5-G.3)"]}, {"code": "SC.5.P.10.4", "desc": "Investigate and explain that electrical energy can be transformed into heat, light, and sound energy, as well as the energy of motion.", "subskills": ["Energy transformation (5-H.1)", "Explore energy transformations: roller coaster ride (6-H.3)"]}, {"code": "SC.5.P.11.1", "desc": "Investigate and illustrate the fact that the flow of electricity requires a closed circuit (a complete loop).", "subskills": ["Electric circuits (5-I.1)"]}, {"code": "SC.5.P.11.2", "desc": "Identify and classify materials that conduct electricity and materials that do not.", "subskills": ["Conductors and insulators (5-I.2)"]}, {"code": "SC.5.P.13.1", "desc": "Identify familiar forces that cause objects to move, such as pushes or pulls, including gravity acting on falling objects.", "subskills": ["Identify directions of forces (5-F.1)"]}, {"code": "SC.5.P.13.2", "desc": "Investigate and describe that the greater the force applied to it, the greater the change in motion of a given object.", "subskills": ["How do balanced and unbalanced forces affect motion? (5-F.2)"]}, {"code": "SC.5.P.13.3", "desc": "Investigate and describe that the more mass an object has, the less effect a given force will have on the object's motion.", "subskills": ["How does mass affect force and acceleration? (5-F.3)"]}, {"code": "SC.5.P.13.4", "desc": "Investigate and explain that when a force is applied to an object but it does not move, it is because another opposing force is being applied by something in the environment so that the forces are balanced.", "subskills": ["How do balanced and unbalanced forces affect motion? (5-F.2)"]}], "meta": {"built": "2025-08-17"}};
let SUBJECTS = ["Reading","Math","Science"];
let STUDENTS = JSON.parse(localStorage.getItem('fl_students')||'[]'); // {name}
let RECORDS = JSON.parse(localStorage.getItem('fl_records')||'[]');
let SETTINGS = JSON.parse(localStorage.getItem('fl_settings')||'{}');
let MS_CFG = JSON.parse(localStorage.getItem('fl_ms_cfg')||'{}'); // {clientId}

// Tabs
const tabs = document.querySelectorAll('.tab');
const sections = document.querySelectorAll('.section');
tabs.forEach(t=>t.addEventListener('click',()=>{
  tabs.forEach(b=>b.classList.remove('active')); t.classList.add('active');
  sections.forEach(s=>s.classList.remove('active')); document.getElementById(t.dataset.tab).classList.add('active');
  if(t.dataset.tab==='records') renderTable();
  if(t.dataset.tab==='student') renderStudentView();
}));

// Elements
const studentSelect = document.getElementById('studentSelect');
const subjectSelect = document.getElementById('subjectSelect');
const standardSelect = document.getElementById('standardSelect');
const subskillSelect = document.getElementById('subskillSelect');
const standardSearch = document.getElementById('standardSearch');
const ratingGroup = document.getElementById('ratingGroup');
const dateInput = document.getElementById('dateInput');
const notesEl = document.getElementById('notes');

const filterStudent = document.getElementById('filterStudent');
const filterCode = document.getElementById('filterCode');
const filterSubject = document.getElementById('filterSubject');
const filterRating = document.getElementById('filterRating');
const tbody = document.querySelector('#dataTable tbody');

const hideNamesEl = document.getElementById('hideNames');
const useInitialsEl = document.getElementById('useInitials');
const studentCount = document.getElementById('studentCount');
const studentViewSelect = document.getElementById('studentViewSelect');
const studentTableBody = document.querySelector('#studentTable tbody');

const msStatus = document.getElementById('msStatus');
const onedriveClientId = document.getElementById('onedriveClientId');

function setToday(){ const d=new Date(); dateInput.value=d.toISOString().slice(0,10); } setToday();

function masked(name){
  if(!hideNamesEl.checked) return name;
  if(useInitialsEl.checked){
    const parts = (name||'').trim().split(/\s+/);
    return parts.map(p=>p[0]?.toUpperCase()||'').join('');
  }
  return 'Student';
}

function renderStudents(){
  studentSelect.innerHTML = '<option value="">' + (STUDENTS.length?'Select student…':'No students yet') + '</option>' + STUDENTS.map((s,i)=>`<option value="${i}">${masked(s.name)}</option>`).join('');
  studentViewSelect.innerHTML = '<option value="">Choose student…</option>' + STUDENTS.map((s,i)=>`<option value="${i}">${masked(s.name)}</option>`).join('');
  studentCount.textContent = STUDENTS.length ? `${STUDENTS.length} students` : 'No students yet';
  localStorage.setItem('fl_students', JSON.stringify(STUDENTS));
}

function renderSubjects(){
  subjectSelect.innerHTML = SUBJECTS.map(s=>`<option value="${s}">${s}</option>`).join('');
  filterSubject.innerHTML = '<option value="">All</option>' + SUBJECTS.map(s=>`<option value="${s}">${s}</option>`).join('');
}

function getStandardsForSubject(subj){ return STANDARDS[subj] || []; }

function renderStandards(){
  const subj = subjectSelect.value;
  const list = getStandardsForSubject(subj);
  const q = standardSearch.value.toLowerCase();
  const filtered = list.filter(x => (x.code+' '+x.desc).toLowerCase().includes(q));
  standardSelect.innerHTML = '<option value="">Select standard…</option>' + filtered.map((x,idx)=>`<option value="${idx}">${x.code} — ${x.desc}</option>`).join('');
  subskillSelect.innerHTML = '<option value="">Select subskill…</option>';
  subskillSelect.disabled = true;
}

function renderSubskills(){
  const subj = subjectSelect.value;
  const idx = standardSelect.value;
  if(idx===''){ subskillSelect.innerHTML = '<option value="">Select subskill…</option>'; subskillSelect.disabled=true; return; }
  const st = getStandardsForSubject(subj)[idx];
  const subs = st.subskills || [];
  subskillSelect.innerHTML = '<option value="">Select subskill…</option>' + subs.map((s,i)=>`<option value="${i}">${s}</option>`).join('');
  subskillSelect.disabled = subs.length===0;
}

// Rating selection
ratingGroup.querySelectorAll('button').forEach(b=>b.addEventListener('click',()=>{
  ratingGroup.querySelectorAll('button').forEach(x=>x.style.borderColor='var(--line)');
  b.style.borderColor='var(--accent)';
  ratingGroup.dataset.value = b.dataset.v;
}));

function saveRecord(){
  const sIdx = studentSelect.value;
  const subj = subjectSelect.value;
  const stdIdx = standardSelect.value;
  const subIdx = subskillSelect.value;
  const rating = parseInt(ratingGroup.dataset.value||'0',10);
  const note = notesEl.value.trim();
  if(sIdx==='') return alert('Choose a student');
  if(!subj) return alert('Choose a subject');
  if(stdIdx==='') return alert('Choose a standard');
  if(!rating) return alert('Pick 1–5');
  const std = getStandardsForSubject(subj)[stdIdx];
  const subskill = (subIdx==='') ? '' : (std.subskills||[])[subIdx]||'';
  const rec = {date: dateInput.value, student: STUDENTS[sIdx].name, subject: subj, code: std.code, standard: std.desc, subskill, rating, notes: note};
  RECORDS.push(rec);
  localStorage.setItem('fl_records', JSON.stringify(RECORDS));
  autoSaveIfEnabled();
  notesEl.value=''; ratingGroup.dataset.value=''; ratingGroup.querySelectorAll('button').forEach(x=>x.style.borderColor='var(--line)');
  alert('Saved');
}

function delRecord(idx){
  if(!confirm('Delete this record?')) return;
  RECORDS.splice(idx,1);
  localStorage.setItem('fl_records', JSON.stringify(RECORDS));
  renderTable();
}

function renderTable(){
  const fs = filterStudent.value.toLowerCase();
  const fc = filterCode.value.toLowerCase();
  const fsubj = filterSubject.value;
  const fr = filterRating.value;
  const rows = RECORDS
    .filter(r => (!fs || r.student.toLowerCase().includes(fs)))
    .filter(r => (!fc || (r.code+' '+r.standard+' '+(r.subskill||'')).toLowerCase().includes(fc)))
    .filter(r => (!fsubj || r.subject===fsubj))
    .filter(r => (!fr || String(r.rating)===fr));
  tbody.innerHTML = rows.map((r,idx)=>`<tr>
    <td>${r.date}</td>
    <td>${masked(r.student)}</td>
    <td>${r.subject}</td>
    <td><span class="badge">${r.code}</span></td>
    <td>${r.standard}</td>
    <td>${r.subskill||''}</td>
    <td><b>${r.rating}</b></td>
    <td>${r.notes||''}</td>
    <td><button onclick="delRecord(${idx})">Delete</button></td>
  </tr>`).join('');
}

// Student view
function delRecordForStudent(idxInFiltered){
  const idx = studentViewSelect.value;
  if(idx===''){ return; }
  const target = STUDENTS[idx]?.name || '';
  const filtered = RECORDS.map((r,i)=>({r,i})).filter(x=>x.r.student===target);
  const realIndex = filtered[idxInFiltered]?.i;
  if(realIndex==null) return;
  if(!confirm('Delete this record?')) return;
  RECORDS.splice(realIndex,1);
  localStorage.setItem('fl_records', JSON.stringify(RECORDS));
  renderStudentView();
}

function renderStudentView(){
  const idx = studentViewSelect.value;
  if(idx===''){ studentTableBody.innerHTML=''; return; }
  const target = STUDENTS[idx]?.name || '';
  const rows = RECORDS.filter(r=>r.student===target);
  studentTableBody.innerHTML = rows.map((r,idx)=>`<tr>
    <td>${r.date}</td><td>${r.subject}</td><td><span class="badge">${r.code}</span></td><td>${r.standard}</td><td>${r.subskill||''}</td><td><b>${r.rating}</b></td><td>${r.notes||''}</td>
    <td><button onclick="delRecordForStudent(${idx})">Delete</button></td>
  </tr>`).join('');
}

// CSV export
function csvFrom(records){
  const header = ["date","student","subject","code","standard","subskill","rating","notes"];
  const lines = [header.join(',')].concat(records.map(r => header.map(h => '"' + String(r[h]||'').replace(/"/g,'""') + '"').join(',')));
  return lines.join('\n');
}

document.getElementById('exportBtn').addEventListener('click', ()=>{
  const blob = new Blob([csvFrom(RECORDS)], {type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='kidvision-records.csv'; a.click();
});
document.getElementById('studentExport').addEventListener('click', ()=>{
  const idx = studentViewSelect.value; if(idx==='') return alert('Choose a student');
  const target = STUDENTS[idx]?.name || '';
  const rows = RECORDS.filter(r=>r.student===target);
  const blob = new Blob([csvFrom(rows)], {type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='kidvision-'+(target||'student')+'.csv'; a.click();
});

// Student management
document.getElementById('addStudentBtn').addEventListener('click', ()=>{
  const name = document.getElementById('newStudentName').value.trim();
  if(!name) return alert('Enter a name');
  STUDENTS.push({name});
  document.getElementById('newStudentName').value='';
  renderStudents();
});
document.getElementById('clearStudentsBtn').addEventListener('click', ()=>{
  if(!confirm('Delete all students?')) return;
  STUDENTS = []; renderStudents();
});

// CSV roster import (bulletproof)
(function(){
  const studentCSV = document.getElementById('studentCSV');
  const importStudentsBtn = document.getElementById('importStudentsBtn');
  const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');

  if (downloadTemplateBtn){
    downloadTemplateBtn.addEventListener('click', ()=>{
      const tmpl = 'name\nAlice Johnson\nBob Smith\n';
      const blob = new Blob([tmpl], {type:'text/csv'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'roster-template.csv'; a.click();
    });
  }

  function normalizeHeader(h){ return String(h).replace(/^[\"\\']|[\"\\']$/g,"").replace(/^\\uFEFF|^\\ufeff/,"").trim().toLowerCase(); }
  function splitLine(line){ if(line.indexOf(",")===-1 && line.indexOf("\\t")!==-1) return line.split("\\t"); return line.split(","); }

  async function importRoster(){
    const f = studentCSV && studentCSV.files ? studentCSV.files[0] : null;
    if(!f) return alert('Choose a CSV file first.');
    let text = await f.text();
    text = text.replace(/\\r\\n/g,"\\n").replace(/\\r/g,"\\n");
    const lines = text.split("\\n").filter(r=>r.trim().length);
    if(!lines.length) return alert('CSV is empty.');
    let headers = splitLine(lines[0]).map(normalizeHeader);
    if(headers.length===1 && headers[0]==="") headers[0]="name";
    let nameIdx = headers.findIndex(h => h==="name" || h==="student" || h==="student_name");
    if(nameIdx===-1) return alert('Could not find a name column. Please include a header named "name".');
    let added=0, seen=new Set(STUDENTS.map(s=>(s.name||"").trim().toLowerCase()));
    for(let i=1;i<lines.length;i++){ const cols=splitLine(lines[i]).map(v=>String(v).replace(/^[\"\\']|[\"\\']$/g,"").replace(/^\\uFEFF|^\\ufeff/,"").trim()); const nm=(cols[nameIdx]||"").trim(); if(!nm) continue; const key=nm.toLowerCase(); if(seen.has(key)) continue; STUDENTS.push({name:nm}); seen.add(key); added++; }
    renderStudents(); alert(added?('Imported '+added+' students.'):'No new students to import.');
  }
  if(importStudentsBtn) importStudentsBtn.addEventListener('click', importRoster);
})();

// ===== Local folder save (File System Access API) =====
const pickDirBtn = document.getElementById('pickDirBtn');
const pickedDirLabel = document.getElementById('pickedDirLabel');
const saveJSONLocal = document.getElementById('saveJSONLocal');
const saveCSVLocal = document.getElementById('saveCSVLocal');
const autoSaveLocal = document.getElementById('autoSaveLocal');

const DB_NAME = 'kidvision-fsa'; const STORE = 'handles';
function idbOpen(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB_NAME,1); r.onupgradeneeded=()=>{ const db=r.result; if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE); }; r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
async function idbGet(k){ const db=await idbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readonly'); const st=tx.objectStore(STORE); const r=st.get(k); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
async function idbSet(k,v){ const db=await idbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); const st=tx.objectStore(STORE); const r=st.put(v,k); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }
async function idbDel(k){ const db=await idbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); const st=tx.objectStore(STORE); const r=st.delete(k); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }

let DIR_HANDLE = null;
function supportFSA(){ return !!window.showDirectoryPicker; }
async function ensurePerm(h){ const p=await h.queryPermission({mode:'readwrite'}); if(p==='granted') return true; const r=await h.requestPermission({mode:'readwrite'}); return r==='granted'; }
function updateDirLabel(){ if(pickedDirLabel) pickedDirLabel.textContent = DIR_HANDLE ? 'Folder selected (permission granted)' : 'No folder selected'; }
async function pickDirectory(){ try{ const h=await window.showDirectoryPicker(); if(!(await ensurePerm(h))){ alert('Permission denied for this folder.'); return; } DIR_HANDLE=h; await idbSet('dir',DIR_HANDLE); updateDirLabel(); }catch(e){ if(e && e.name!=='AbortError') alert('Could not pick folder: '+e.message); } }
async function loadStoredDirectory(){ try{ const h=await idbGet('dir'); if(!h) return; if(await ensurePerm(h)){ DIR_HANDLE=h; updateDirLabel(); } else { await idbDel('dir'); DIR_HANDLE=null; updateDirLabel(); } }catch(e){} }
async function writeFile(handle, filename, contents){ const fh=await handle.getFileHandle(filename,{create:true}); const w=await fh.createWritable(); await w.write(contents); await w.close(); }
function csvAll(){ return csvFrom(RECORDS); }
if(pickDirBtn) pickDirBtn.addEventListener('click', async ()=>{ if(!supportFSA()) return alert('Your browser does not support choosing a local folder. Use Chrome/Edge on desktop.'); await pickDirectory(); });
if(saveJSONLocal) saveJSONLocal.addEventListener('click', async ()=>{ const dump=JSON.stringify({students:STUDENTS,records:RECORDS,settings:SETTINGS},null,2); const fname='kidvision-backup-'+new Date().toISOString().slice(0,10)+'.json'; if(DIR_HANDLE){ try{ await writeFile(DIR_HANDLE,fname,dump); alert('Saved '+fname+' to selected folder.'); }catch(e){ alert('Save failed: '+e.message); } } else { const blob=new Blob([dump],{type:'application/json'}); const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download=fname; a.click(); } });
if(saveCSVLocal) saveCSVLocal.addEventListener('click', async ()=>{ const csv=csvAll(); const fname='kidvision-records-'+new Date().toISOString().slice(0,10)+'.csv'; if(DIR_HANDLE){ try{ await writeFile(DIR_HANDLE,fname,csv); alert('Saved '+fname+' to selected folder.'); }catch(e){ alert('Save failed: '+e.message); } } else { const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download=fname; a.click(); } });
const AUTO_KEY='kv_auto_save_local'; if(autoSaveLocal){ autoSaveLocal.checked=(localStorage.getItem(AUTO_KEY)==='1'); autoSaveLocal.addEventListener('change',()=>{ localStorage.setItem(AUTO_KEY, autoSaveLocal.checked?'1':'0'); }); }
async function autoSaveIfEnabled(){ if(localStorage.getItem(AUTO_KEY)!=='1' || !DIR_HANDLE) return; const d=new Date().toISOString().slice(0,10); try{ await writeFile(DIR_HANDLE,'kidvision-records-'+d+'.csv', csvAll()); await writeFile(DIR_HANDLE,'kidvision-backup-'+d+'.json', JSON.stringify({students:STUDENTS,records:RECORDS,settings:SETTINGS},null,2)); }catch(e){ console.warn('Auto-save failed',e); } }
loadStoredDirectory();

// ===== OneDrive via MSAL (App-ID ready) =====
(function(){ const url=new URL(window.location.href); const q=url.searchParams.get('msid'); if(q){ MS_CFG.clientId=q.trim(); localStorage.setItem('fl_ms_cfg', JSON.stringify(MS_CFG)); } })();

let msalInstance = null; let msalAccount = null;
const GRAPH_SCOPES = ["Files.ReadWrite.AppFolder"];
const GRAPH_UPLOAD_URL = "https://graph.microsoft.com/v1.0/me/drive/special/approot:/KidVision/";

function updateMsStatus(){ if(!msStatus) return; const who = msalAccount ? (msalAccount.username || msalAccount.localAccountId) : "Signed out"; msStatus.textContent = "Status: " + who + (MS_CFG.clientId ? " • App ID set" : " • App ID missing"); }
window.addEventListener('load', () => { if(onedriveClientId && MS_CFG.clientId) onedriveClientId.value = MS_CFG.clientId; if (window.msal && MS_CFG.clientId) { msalInstance = new msal.PublicClientApplication({ auth: { clientId: MS_CFG.clientId, authority: "https://login.microsoftonline.com/common", redirectUri: window.location.href.split('#')[0] }, cache: { cacheLocation: "localStorage" } }); const accs = msalInstance.getAllAccounts(); if(accs.length) { msalAccount = accs[0]; } } updateMsStatus(); });
document.getElementById('saveClientId').addEventListener('click', ()=>{ MS_CFG.clientId = onedriveClientId.value.trim(); localStorage.setItem('fl_ms_cfg', JSON.stringify(MS_CFG)); alert('Saved Microsoft App ID. Reload the page.'); });
document.getElementById('msLogin').addEventListener('click', async ()=>{ if(!MS_CFG.clientId) return alert('Enter and save your Microsoft App ID first.'); if(!msalInstance) msalInstance = new msal.PublicClientApplication({ auth: { clientId: MS_CFG.clientId, authority: "https://login.microsoftonline.com/common", redirectUri: window.location.href.split('#')[0] }, cache: { cacheLocation: "localStorage" } }); try { const result = await msalInstance.loginPopup({ scopes: GRAPH_SCOPES }); msalAccount = result.account; updateMsStatus(); } catch(e) { alert('Login failed: '+e); } });
document.getElementById('msLogout').addEventListener('click', async ()=>{ if(!msalInstance || !msalAccount) return; await msalInstance.logoutPopup({ account: msalAccount }); msalAccount = null; updateMsStatus(); });
async function getGraphToken(){ if(!msalInstance || !msalAccount) throw new Error('Not signed in'); try { const r = await msalInstance.acquireTokenSilent({ account: msalAccount, scopes: GRAPH_SCOPES }); return r.accessToken; } catch(e) { const r = await msalInstance.acquireTokenPopup({ scopes: GRAPH_SCOPES }); return r.accessToken; } }
async function uploadText(filename, text){ const token = await getGraphToken(); const url = GRAPH_UPLOAD_URL + encodeURIComponent(filename) + ':/content'; const resp = await fetch(url, { method:'PUT', headers: { 'Authorization':'Bearer '+token, 'Content-Type':'text/plain' }, body: text }); if(!resp.ok) throw new Error('Upload failed: '+resp.status); alert('Uploaded to OneDrive: '+filename+' (App folder)'); }
document.getElementById('backupJSON').addEventListener('click', async ()=>{ const dump = JSON.stringify({ students: STUDENTS, records: RECORDS, settings: SETTINGS }, null, 2); try { await uploadText('backup-'+new Date().toISOString().slice(0,10)+'.json', dump); } catch(e) { alert(e.message); } });
document.getElementById('backupCSV').addEventListener('click', async ()=>{ const csv = csvFrom(RECORDS); try { await uploadText('records-'+new Date().toISOString().slice(0,10)+'.csv', csv); } catch(e) { alert(e.message); } });

// Init
standardSearch.addEventListener('input', renderStandards);
subjectSelect.addEventListener('change', renderStandards);
standardSelect.addEventListener('change', renderSubskills);
document.getElementById('saveBtn').addEventListener('click', saveRecord);
function init(){ renderStudents(); renderSubjects(); renderStandards(); renderTable(); } init();


// ===== Supabase Access Gate (single-use) =====
let SB_CFG = JSON.parse(localStorage.getItem('kv_supabase_cfg')||'{}');
const SB_URL_DEFAULT = "https://pgmxbogkgnpekjoolgte.supabase.co";  // prefilled from you
const SB_KEY_DEFAULT = "PASTE-YOUR-ANON-KEY";                       // <-- paste anon public key here

function getSbUrl(){ return SB_CFG.url || SB_URL_DEFAULT; }
function getSbKey(){ return SB_CFG.key || SB_KEY_DEFAULT; }

async function redeemInvite(code, email){
  const url = getSbUrl();
  const key = getSbKey();
  if(!url || !key){ setGateErr('App not configured. Paste Supabase URL and anon key in Settings.'); return false; }
  try{
    const resp = await fetch(`${url}/rest/v1/rpc/redeem_code`, {
      method: 'POST',
      headers: {
        'apikey': key,
        'Authorization': `Bearer ${key}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ input_code: code, input_email: email })
    });
    if(!resp.ok){
      const text = await resp.text();
      console.error('Supabase RPC error:', resp.status, text);
      setGateErr('Server error. Check your URL/key/RPC.');
      return false;
    }
    const ok = await resp.json();
    return !!ok;
  }catch(e){
    console.error('Redeem error:', e);
    setGateErr('Network error.');
    return false;
  }
}

function setGateErr(msg){
  const el = document.getElementById('gateErr');
  if(el) el.textContent = msg;
}

async function validateGate(){
  const email = (document.getElementById('gateEmail').value||'').trim();
  const code = (document.getElementById('gateCode').value||'').trim();
  if(!email){ setGateErr('Enter your email.'); return; }
  if(!code){ setGateErr('Enter your invite code.'); return; }
  const ok = await redeemInvite(code, email);
  if(ok){
    localStorage.setItem('kv_access_granted','1');
    const ov = document.getElementById('gateOverlay'); if(ov) ov.style.display='none';
  }else{
    setGateErr('Invalid or already redeemed code.');
  }
}

(function initGate(){
  const btn = document.getElementById('gateSubmit');
  if(btn) btn.addEventListener('click', validateGate);
  const codeInput = document.getElementById('gateCode');
  if(codeInput){ codeInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') validateGate(); }); }

  if(localStorage.getItem('kv_access_granted')!=='1'){
    const ov = document.getElementById('gateOverlay'); if(ov) ov.style.display='flex';
  }
})();

// Settings UI for Supabase config
(function(){
  const sbUrl = document.getElementById('sbUrl');
  const sbKey = document.getElementById('sbKey');
  const saveSb = document.getElementById('saveSb');
  if(sbUrl) sbUrl.value = SB_CFG.url || SB_URL_DEFAULT;
  if(sbKey) sbKey.value = SB_CFG.key || "";
  if(saveSb){
    saveSb.addEventListener('click', ()=>{
      SB_CFG = { url: sbUrl.value.trim(), key: sbKey.value.trim() };
      localStorage.setItem('kv_supabase_cfg', JSON.stringify(SB_CFG));
      alert('Saved. Reloading…'); location.reload();
    });
  }
})();

// Service worker
if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js')); }
</script>
</body>
</html>
